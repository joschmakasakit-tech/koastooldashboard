<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Dashboard</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    transitionDuration: {
                        '200': '200ms',
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Remove blue outline on focus */
        *:focus {
            outline: none !important;
        }

        /* Hardware acceleration for smoother animations */
        .sidebar-item, .modal-content {
            transform: translateZ(0);
            backface-visibility: hidden;
        }
    </style>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.294.0"
            }
        }
    </script>

    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#050507] text-slate-200">
    <div id="root"></div>

    <!-- MAIN APPLICATION CODE -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            FileSpreadsheet, 
            Settings, 
            Clock,
            PieChart, 
            Plus,
            X,
            Globe,
            Trash2,
            Check,
            Layout,
            Columns,
            Maximize,
            ShieldAlert,
            Box,
            User,
            Bell,
            ChevronUp,
            ChevronDown,
            Music,
            Play,
            Hourglass,
            Hash,
            DollarSign,
            Minus,
            MessageSquare,
            TrendingUp,
            Activity,
            FileText,
            StickyNote,
            PenLine,
            Link as LinkIcon
        } from 'lucide-react';

        // --- Constants ---
        const RINGTONES = [
            { id: 'classic', name: 'Classic Bell', url: 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3' },
            { id: 'digital', name: 'Digital Pulse', url: 'https://assets.mixkit.co/active_storage/sfx/2864/2864-preview.mp3' },
            { id: 'soft', name: 'Soft Chime', url: 'https://assets.mixkit.co/active_storage/sfx/2873/2873-preview.mp3' },
        ];

        // --- Custom Hooks ---
        
        // Hook to persist state to local storage with a debounce to prevent lag on typing
        const useDebouncedPersistence = (key, value, delay = 500) => {
            useEffect(() => {
                const handler = setTimeout(() => {
                    localStorage.setItem(key, JSON.stringify(value));
                }, delay);
                return () => clearTimeout(handler);
            }, [key, value, delay]);
        };

        // --- Components ---

        // Memoized SidebarItem to prevent unnecessary re-renders
        const SidebarItem = React.memo(({ icon: Icon, active, onClick, onDoubleClick, isTimer }) => (
            <button
                onClick={onClick}
                onDoubleClick={onDoubleClick}
                className={`
                sidebar-item w-12 h-12 flex items-center justify-center rounded-xl transition-all duration-200 group relative
                ${active
                    ? 'bg-purple-600/20 text-purple-200 border border-purple-500/30 shadow-[0_0_15px_rgba(168,85,247,0.15)]' 
                    : 'text-slate-400 hover:bg-white/5 hover:text-white'
                }
                `}
            >
                <Icon size={24} className={`transition-colors duration-200 ${active ? 'text-purple-400' : 'text-slate-500 group-hover:text-purple-400'}`} />
                {isTimer && active && <div className="absolute -right-1 top-1 w-2 h-2 bg-purple-400 rounded-full shadow-[0_0_5px_rgba(168,85,247,0.8)]" />}
            </button>
        ));

        // Memoized TallyRow for smooth counting
        const TallyRow = React.memo(({ label, count, onDecrement, onIncrement, colorClass }) => (
            <div className="flex items-center justify-between py-5 border-b border-white/5 last:border-0 group/row hover:bg-white/[0.02] -mx-4 px-4 transition-colors duration-200">
            <div className="flex items-center gap-4">
                <div className={`w-2.5 h-2.5 rounded-full shadow-[0_0_8px_rgba(0,0,0,0.5)] ${colorClass || 'bg-slate-500'}`} />
                <span className="text-base font-medium text-slate-400 group-hover/row:text-slate-200 transition-colors duration-200">{label}</span>
            </div>
            
            <div className="flex items-center gap-8">
                <span className="text-white font-light text-3xl min-w-[3rem] text-right tracking-tight">{count}</span>
                
                <div className="flex items-center gap-3">
                <button 
                    onClick={onDecrement}
                    className="w-12 h-12 rounded-xl bg-white/5 hover:bg-white/10 text-slate-500 hover:text-white flex items-center justify-center transition-all duration-200 active:scale-95 border border-white/5 hover:border-white/10"
                >
                    <Minus size={20} />
                </button>
                <button 
                    onClick={onIncrement}
                    className="w-12 h-12 rounded-xl bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 hover:text-white flex items-center justify-center transition-all duration-200 active:scale-95 border border-purple-500/20 hover:border-purple-500/40"
                >
                    <Plus size={20} />
                </button>
                </div>
            </div>
            </div>
        ));

        const AnalyticsModule = ({ models, setModels }) => {
        
        const updateTally = useCallback((id, type, change) => {
            setModels(prev => prev.map(m => {
            if (m.id === id) {
                const currentTally = m[type] || 0;
                const newTally = Math.max(0, currentTally + change);
                return { ...m, [type]: newTally };
            }
            return m;
            }));
        }, [setModels]);

        const updateSalesText = useCallback((id, text) => {
            setModels(prev => prev.map(m => {
            if (m.id === id) {
                return { ...m, salesText: text };
            }
            return m;
            }));
        }, [setModels]);

        // Helper functions moved out or memoized
        const calculateLineTotal = (line) => {
            if (!line.includes('-')) return 0;
            const parts = line.split('-');
            if (parts.length < 2) return 0;
            const expression = parts[1];
            const numbers = expression.split('+').map(num => parseFloat(num.trim()));
            return numbers.reduce((acc, curr) => acc + (isNaN(curr) ? 0 : curr), 0);
        };

        const calculateModelTotal = (text) => {
            if (!text) return 0;
            const lines = text.split('\n');
            return lines.reduce((acc, line) => acc + calculateLineTotal(line), 0);
        };

        const calculateOverallTotal = () => {
            return models.reduce((acc, m) => acc + calculateModelTotal(m.salesText), 0);
        };

        // Memoize expensive calculations
        const overallRevenue = useMemo(() => calculateOverallTotal(), [models]);
        const netSales = useMemo(() => overallRevenue * 0.8, [overallRevenue]);

        return (
            <div className="flex flex-col h-full bg-[#0a0a0c] p-8 lg:p-12 overflow-y-auto">
            <div className="max-w-7xl w-full mx-auto h-full flex flex-col">
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 min-h-0">
                
                {/* Tally Count Section */}
                <div className="flex flex-col h-full">
                    <div className="flex items-center gap-3 mb-6">
                    <div className="p-2.5 rounded-xl bg-purple-500/10 text-purple-400 border border-purple-500/20 shadow-[0_0_15px_rgba(168,85,247,0.1)]">
                        <MessageSquare size={20} />
                    </div>
                    <h3 className="text-lg font-medium text-white">Response Tally</h3>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-white/10 -mr-2">
                    {models.length === 0 ? (
                        <div className="h-64 border border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center text-slate-500 bg-white/[0.01]">
                        <MessageSquare size={32} className="opacity-20 mb-4" />
                        <p className="text-sm font-medium">No Active Models</p>
                        <p className="text-xs text-slate-600 mt-1">Configure talent in Settings to view data.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-4">
                        {models.map((model) => (
                            <div 
                            key={model.id} 
                            className="bg-[#121214] border border-white/5 hover:border-purple-500/20 rounded-3xl p-8 relative group transition-all duration-300 shadow-sm hover:shadow-2xl hover:shadow-purple-900/10"
                            >
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-5">
                                <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500/20 to-indigo-500/20 flex items-center justify-center text-purple-300 border border-white/5 shadow-inner">
                                    <User size={28} />
                                </div>
                                <div>
                                    <h4 className="text-white text-2xl font-light tracking-wide">{model.name}</h4>
                                    <div className="flex items-center gap-2 mt-1">
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-500" />
                                    <p className="text-xs text-slate-500 uppercase tracking-widest font-semibold">{model.category}</p>
                                    </div>
                                </div>
                                </div>
                                <div className="text-xs bg-white/5 px-3 py-1.5 rounded-lg text-slate-500 border border-white/5">
                                ID: {model.id.toString().slice(-4)}
                                </div>
                            </div>
                            
                            <div className="space-y-1 bg-[#0a0a0c]/50 rounded-2xl p-4 border border-white/5">
                                <TallyRow 
                                    label="MM Reply" 
                                    count={model.tallyMM || 0} 
                                    colorClass="bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.6)]"
                                    onDecrement={() => updateTally(model.id, 'tallyMM', -1)}
                                    onIncrement={() => updateTally(model.id, 'tallyMM', 1)}
                                />
                                <TallyRow 
                                    label="WM Reply" 
                                    count={model.tallyWM || 0} 
                                    colorClass="bg-pink-400 shadow-[0_0_8px_rgba(244,114,182,0.6)]"
                                    onDecrement={() => updateTally(model.id, 'tallyWM', -1)}
                                    onIncrement={() => updateTally(model.id, 'tallyWM', 1)}
                                />
                                <TallyRow 
                                    label="Story Reply" 
                                    count={model.tallyStory || 0} 
                                    colorClass="bg-amber-400 shadow-[0_0_8px_rgba(251,191,36,0.6)]"
                                    onDecrement={() => updateTally(model.id, 'tallyStory', -1)}
                                    onIncrement={() => updateTally(model.id, 'tallyStory', 1)}
                                />
                            </div>
                            </div>
                        ))}
                        </div>
                    )}
                    </div>
                </div>

                {/* Sales Count Section */}
                <div className="flex flex-col h-full">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                        <div className="p-2.5 rounded-xl bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_15px_rgba(16,185,129,0.1)]">
                            <DollarSign size={20} />
                        </div>
                        <h3 className="text-lg font-medium text-white">Sales</h3>
                        </div>
                        
                        {/* Overall Total Display */}
                        <div className="flex items-center gap-3">
                        <div className="flex items-center gap-3 bg-[#151518] px-4 py-2 rounded-xl border border-emerald-500/20 shadow-[0_0_15px_rgba(16,185,129,0.05)]">
                            <span className="text-xs text-slate-500 uppercase tracking-wider font-semibold">Total Sales</span>
                            <span className="text-xl font-light text-emerald-400 tracking-tight">${overallRevenue.toFixed(2)}</span>
                        </div>
                        <div className="flex items-center gap-3 bg-[#151518] px-4 py-2 rounded-xl border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.05)]">
                            <span className="text-xs text-slate-500 uppercase tracking-wider font-semibold">Net Sales</span>
                            <span className="text-xl font-light text-blue-400 tracking-tight">${netSales.toFixed(2)}</span>
                        </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-white/10 -mr-2">
                    {models.length === 0 ? (
                        <div className="h-64 border border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center text-slate-500 bg-white/[0.01]">
                            <Activity size={32} className="opacity-20 mb-4" />
                            <p className="text-sm font-medium">No Data Source</p>
                            <p className="text-xs text-slate-600 mt-1">Add models to enable sales tracking.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-4">
                            {models.map((model) => {
                            // Calculate per-model totals inside the map, efficient enough
                            const modelTotal = calculateModelTotal(model.salesText);
                            const modelNet = modelTotal * 0.8;
                            return (
                                <div 
                                key={model.id}
                                className="bg-[#121214] border border-white/5 hover:border-emerald-500/20 rounded-3xl p-8 relative group transition-all duration-300 shadow-sm hover:shadow-2xl hover:shadow-emerald-900/10 flex flex-col h-[400px]"
                                >
                                {/* Header */}
                                <div className="flex items-center justify-between mb-6">
                                    <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center text-emerald-300 border border-white/5">
                                        <DollarSign size={20} />
                                    </div>
                                    <div>
                                        <h4 className="text-white text-lg font-medium tracking-wide">{model.name}</h4>
                                        <p className="text-[10px] text-emerald-500 uppercase tracking-widest font-bold">
                                        Total: ${modelTotal.toFixed(2)} <span className="text-blue-400">(${modelNet.toFixed(2)})</span>
                                        </p>
                                    </div>
                                    </div>
                                </div>

                                {/* Text Area Input */}
                                <div className="flex-1 bg-[#0a0a0c]/80 rounded-2xl border border-white/10 focus-within:border-emerald-500/40 focus-within:ring-1 focus-within:ring-emerald-500/20 transition-all relative overflow-hidden flex flex-col">
                                    <div className="flex items-center gap-2 px-4 py-2 border-b border-white/5 bg-white/[0.02]">
                                        <FileText size={12} className="text-slate-500" />
                                        <span className="text-[10px] text-slate-500 uppercase tracking-wider">Sales Report Log</span>
                                    </div>
                                    <textarea 
                                        value={model.salesText || ''}
                                        onChange={(e) => updateSalesText(model.id, e.target.value)}
                                        placeholder={`Format:\nUser1 - 35\nUser2 - 15 + 35\nUser3 - 150`}
                                        className="flex-1 w-full bg-transparent border-none resize-none p-4 text-sm text-slate-300 placeholder:text-slate-700 focus:outline-none leading-relaxed scrollbar-thin scrollbar-thumb-white/10"
                                        spellCheck="false"
                                    />
                                </div>
                                </div>
                            );
                            })}
                        </div>
                    )}
                    </div>
                </div>

                </div>
            </div>
            </div>
        );
        };

        const SettingsModule = ({ models, setModels, currentRingtone, setRingtone }) => {
        const [newModel, setNewModel] = useState('');
        const audioPreviewRef = useRef(null);

        const addModel = (e) => {
            e.preventDefault();
            if (!newModel.trim()) return;
            setModels([...models, {
            id: Date.now(),
            name: newModel,
            category: 'New Face',
            status: 'available',
            tallyMM: 0,
            tallyWM: 0,
            tallyStory: 0,
            salesText: '' 
            }]);
            setNewModel('');
        };

        const deleteModel = (id) => {
            setModels(models.filter(m => m.id !== id));
        };

        const playPreview = (url) => {
            if (audioPreviewRef.current) {
            audioPreviewRef.current.src = url;
            audioPreviewRef.current.play().catch(e => console.log("Audio play failed", e));
            }
        };

        return (
            <div className="flex flex-col h-full bg-[#0a0a0c] p-8 lg:p-12 overflow-y-auto">
            <audio ref={audioPreviewRef} />

            <div className="max-w-5xl w-full mx-auto space-y-12">
                
                {/* Section 1: Talent */}
                <div>
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-8">
                    {/* Input Section */}
                    <div className="bg-[#0f0f12] border border-white/5 rounded-2xl p-1 shadow-lg shadow-purple-900/5">
                        <form onSubmit={addModel} className="flex items-center">
                        <div className="pl-4 pr-3 text-slate-500">
                            <Box size={20} />
                        </div>
                        <input
                            type="text"
                            value={newModel}
                            onChange={(e) => setNewModel(e.target.value)}
                            placeholder="Input model name (e.g. Sarah Jenkins)..."
                            className="flex-1 bg-transparent border-none text-white placeholder:text-slate-600 focus:ring-0 h-14"
                        />
                        <button
                            type="submit"
                            className="m-1 w-12 h-12 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-medium shadow-[0_0_15px_rgba(168,85,247,0.3)] transition-all duration-200 flex items-center justify-center"
                        >
                            <Plus size={24} />
                        </button>
                        </form>
                    </div>

                    {/* List Section */}
                    <div className="grid gap-3">
                        {models.map(model => (
                        <div key={model.id} className="group flex items-center justify-between p-5 bg-[#0f0f12]/50 hover:bg-[#0f0f12] border border-white/5 hover:border-purple-500/20 rounded-2xl transition-all duration-200">
                            <div className="flex items-center gap-5">
                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center transition-colors ${
                                model.status === 'available' 
                                ? 'bg-gradient-to-br from-purple-500/10 to-indigo-500/10 text-purple-400 border border-purple-500/10' 
                                : 'bg-amber-500/10 text-amber-500 border border-amber-500/10'
                            }`}>
                                <User size={22} />
                            </div>
                            <div>
                                <h4 className={`font-medium text-lg ${model.status === 'available' ? 'text-slate-200' : 'text-slate-400'}`}>{model.name}</h4>
                            </div>
                            </div>

                            <div className="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                onClick={() => deleteModel(model.id)}
                                className="p-2.5 text-slate-500 hover:text-red-400 hover:bg-red-500/10 hover:border-red-500/20 border border-transparent rounded-lg transition-colors"
                            >
                                <Trash2 size={18} />
                            </button>
                            </div>
                        </div>
                        ))}
                        
                        {models.length === 0 && (
                            <div className="p-12 text-center border-2 border-dashed border-white/5 rounded-2xl">
                            <p className="text-slate-600">No models added yet. Your data will be saved.</p>
                            </div>
                        )}
                    </div>
                </div>
                </div>

                {/* Section 2: Notifications */}
                <div className="border-t border-white/5 pt-10">
                <h2 className="text-2xl font-light text-white mb-2">Timer Settings</h2>
                <p className="text-slate-500 mb-6">Select the alert sound for completed timers.</p>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {RINGTONES.map(tone => (
                    <div 
                        key={tone.id}
                        onClick={() => setRingtone(tone.id)}
                        className={`
                            cursor-pointer p-4 rounded-xl border transition-all duration-200 flex items-center gap-3 relative overflow-hidden group
                            ${currentRingtone === tone.id 
                            ? 'bg-purple-600/10 border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.15)]' 
                            : 'bg-[#0f0f12] border-white/5 hover:border-white/10'
                            }
                        `}
                    >
                        <div className={`
                            w-10 h-10 rounded-full flex items-center justify-center transition-colors
                            ${currentRingtone === tone.id ? 'bg-purple-600 text-white' : 'bg-white/5 text-slate-500'}
                        `}>
                            <Music size={18} />
                        </div>
                        
                        <div className="flex-1">
                        <h4 className={`text-sm font-medium ${currentRingtone === tone.id ? 'text-white' : 'text-slate-400'}`}>
                            {tone.name}
                        </h4>
                        <p className="text-[10px] text-slate-600 uppercase tracking-wider">3 Seconds</p>
                        </div>

                        <button
                        onClick={(e) => { e.stopPropagation(); playPreview(tone.url); }}
                        className="p-2 text-slate-500 hover:text-white hover:bg-white/10 rounded-full transition-colors z-10"
                        >
                        <Play size={14} />
                        </button>

                        {currentRingtone === tone.id && (
                        <div className="absolute inset-0 border-2 border-purple-500/20 rounded-xl pointer-events-none" />
                        )}
                    </div>
                    ))}
                </div>
                </div>

            </div>
            </div>
        );
        };

        const SalesSheetModule = ({ url }) => {
        if (!url) {
            return (
            <div className="flex flex-col items-center justify-center h-full text-slate-500 bg-[#0a0a0c]">
                <div className="p-6 rounded-full bg-white/5 mb-6">
                <DollarSign size={48} className="text-slate-600 opacity-50" />
                </div>
                <h2 className="text-xl font-light text-slate-400">Sales Sheet</h2>
                <p className="text-sm text-slate-600 mt-2 text-center max-w-xs">
                Double-click the <DollarSign size={14} className="inline mx-1" /> icon in the sidebar to link your sales spreadsheet.
                </p>
            </div>
            );
        }
        
        return (
            <div className="w-full h-full bg-white">
            <iframe 
                src={url} 
                className="w-full h-full border-none"
                title="Sales Sheet"
            />
            </div>
        );
        };

        const NotesModule = () => {
        const [notes, setNotes] = useState(() => {
            const saved = localStorage.getItem('nexus_notes');
            return saved ? JSON.parse(saved) : [
            { id: 1, title: 'Quick Notes', content: '' }
            ];
        });
        
        // Debounce saving notes to prevent lag on typing
        useDebouncedPersistence('nexus_notes', notes, 1000);
        
        // Split Screen State
        const [isSplitMode, setIsSplitMode] = useState(false);
        const [activePane, setActivePane] = useState('primary'); // 'primary' | 'secondary'
        const [primaryNoteId, setPrimaryNoteId] = useState(() => notes[0]?.id || 1);
        const [secondaryNoteId, setSecondaryNoteId] = useState(null); 

        // Editing State
        const [isEditing, setIsEditing] = useState(false);
        const [editingNote, setEditingNote] = useState(null);

        // Helper to get note
        const getNote = (id) => notes.find(n => n.id === id) || notes[0];

        const handleTabClick = (id) => {
            if (isSplitMode) {
            if (activePane === 'primary') {
                setPrimaryNoteId(id);
            } else {
                setSecondaryNoteId(id);
            }
            } else {
            setPrimaryNoteId(id);
            }
        };

        const toggleSplitMode = () => {
            if (!isSplitMode) {
            if (!secondaryNoteId) setSecondaryNoteId(primaryNoteId);
            setIsSplitMode(true);
            setActivePane('secondary');
            } else {
            setIsSplitMode(false);
            setActivePane('primary');
            }
        };

        const handleAddNote = () => {
            const newId = Date.now();
            const newNote = { id: newId, title: 'Untitled Note', content: '' };
            setNotes([...notes, newNote]);
            handleTabClick(newId);
            setEditingNote(newNote);
            setIsEditing(true);
        };

        // Use callback for smoother updates
        const handleUpdateContent = (id, newContent) => {
            setNotes(prev => prev.map(n => n.id === id ? { ...n, content: newContent } : n));
        };

        const handleSaveRename = (e) => {
            e.preventDefault();
            setNotes(notes.map(n => n.id === editingNote.id ? editingNote : n));
            setIsEditing(false);
            setEditingNote(null);
        };

        const handleDeleteNote = (id) => {
            if (notes.length === 1) return;
            const newNotes = notes.filter(n => n.id !== id);
            setNotes(newNotes);
            
            // Safety fallback
            const fallbackId = newNotes[0].id;
            if (primaryNoteId === id) setPrimaryNoteId(fallbackId);
            if (secondaryNoteId === id) setSecondaryNoteId(fallbackId);
        };

        // Render a single pane
        const renderPane = (noteId, paneType) => {
            const note = getNote(noteId);
            const isActive = isSplitMode && activePane === paneType;

            return (
            <div 
                className={`
                flex-1 relative h-full transition-all duration-300 flex flex-col overflow-hidden
                ${isActive ? 'ring-2 ring-purple-500/50 z-10' : 'ring-0'}
                ${isSplitMode && paneType === 'primary' ? 'border-r border-white/10' : ''}
                `}
                onClick={() => isSplitMode && setActivePane(paneType)}
            >
                {isSplitMode && !isActive && (
                <div className="absolute inset-0 z-20 bg-black/10 hover:bg-transparent cursor-pointer transition-colors" />
                )}

                <div className="flex-1 bg-[#121214] p-8 relative flex flex-col h-full">
                    <div className="flex items-center gap-3 mb-6 pb-4 border-b border-white/5">
                        <div className="p-2 rounded-lg bg-amber-500/10 text-amber-400">
                        <PenLine size={18} />
                        </div>
                        <h3 className="text-white font-medium text-lg truncate">{note.title}</h3>
                        <div className="flex-1" />
                        <div className="text-xs text-slate-500 font-mono">
                        {note.content.length} chars
                        </div>
                    </div>
                    <textarea 
                    value={note.content}
                    onChange={(e) => handleUpdateContent(note.id, e.target.value)}
                    placeholder="Start typing your notes here..."
                    className="flex-1 w-full bg-transparent border-none resize-none text-slate-300 placeholder:text-slate-600 focus:outline-none leading-relaxed text-base scrollbar-thin scrollbar-thumb-white/10"
                    spellCheck="false"
                    />
                </div>
            </div>
            );
        };

        const currentTabId = isSplitMode 
            ? (activePane === 'primary' ? primaryNoteId : secondaryNoteId)
            : primaryNoteId;

        return (
            <div className="flex flex-col h-full relative bg-[#0a0a0c]">
            {/* Top Tab Bar */}
            <div className="h-10 bg-[#0a0a0c] border-b border-white/5 flex items-center px-2 space-x-1 relative z-20">
                <div className="flex-1 flex items-center overflow-x-auto h-full scrollbar-hide">
                {notes.map((note) => (
                    <div 
                    key={note.id}
                    onClick={() => handleTabClick(note.id)}
                    onDoubleClick={(e) => {
                        e.stopPropagation();
                        setEditingNote(note);
                        setIsEditing(true);
                    }}
                    title="Double-click to rename"
                    className={`
                        group flex items-center px-4 h-full rounded-t-lg cursor-pointer transition-all duration-200 select-none min-w-[120px] max-w-[200px] relative top-[1px]
                        ${currentTabId === note.id 
                        ? 'bg-[#0f0f12] text-purple-200 border-t border-x border-purple-500/30 border-b-[#0f0f12]' 
                        : 'text-slate-500 hover:bg-white/5 hover:text-slate-300 border-t border-x border-transparent'
                        }
                    `}
                    >
                    <span className="text-xs font-medium truncate flex-1 text-center">{note.title}</span>
                    </div>
                ))}
                
                <button 
                    onClick={handleAddNote}
                    className="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-purple-400 hover:bg-white/5 rounded-full transition-colors ml-1 shrink-0"
                >
                    <Plus size={16} />
                </button>
                </div>

                {/* Split Screen Toggle */}
                <div className="border-l border-white/10 pl-2 ml-2 flex items-center">
                <button
                    onClick={toggleSplitMode}
                    title={isSplitMode ? "Single View" : "Split View"}
                    className={`
                    w-8 h-8 flex items-center justify-center rounded-lg transition-colors
                    ${isSplitMode 
                        ? 'bg-purple-600 text-white shadow-[0_0_10px_rgba(168,85,247,0.4)]' 
                        : 'text-slate-500 hover:text-purple-400 hover:bg-white/5'
                    }
                    `}
                >
                    {isSplitMode ? <Maximize size={16} /> : <Columns size={16} />}
                </button>
                </div>
            </div>

            {/* Main Content Area - Split Logic */}
            <div className="flex-1 relative w-full h-full bg-[#0f0f12] flex flex-row">
                {renderPane(primaryNoteId, 'primary')}
                {isSplitMode && renderPane(secondaryNoteId, 'secondary')}
            </div>

            {/* Rename Modal Overlay */}
            {isEditing && editingNote && (
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-content">
                <div className="w-80 bg-[#1a1a1c] border border-white/10 rounded-2xl p-6 shadow-2xl shadow-purple-900/20">
                    <div className="flex justify-between items-center mb-6">
                    <h3 className="text-white font-medium flex items-center gap-2">
                        <StickyNote size={18} className="text-purple-400" />
                        Rename Note
                    </h3>
                    <button onClick={() => setIsEditing(false)} className="text-slate-500 hover:text-white">
                        <X size={18} />
                    </button>
                    </div>
                    
                    <form onSubmit={handleSaveRename} className="space-y-4">
                    <div>
                        <label className="block text-xs uppercase tracking-wider text-slate-500 font-semibold mb-2">Note Title</label>
                        <input 
                        type="text" 
                        value={editingNote.title}
                        onChange={(e) => setEditingNote({...editingNote, title: e.target.value})}
                        className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2.5 text-white text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500/50 transition-all"
                        placeholder="e.g. Daily Tasks"
                        autoFocus
                        />
                    </div>

                    <div className="flex gap-3 mt-6 pt-4 border-t border-white/5">
                        <button 
                        type="button"
                        onClick={() => {
                            handleDeleteNote(editingNote.id);
                            setIsEditing(false);
                        }}
                        className="flex items-center justify-center px-4 py-2 bg-red-500/10 text-red-400 hover:bg-red-500/20 rounded-lg text-sm font-medium transition-colors"
                        >
                        <Trash2 size={16} />
                        </button>
                        <div className="flex-1"></div>
                        <button 
                        type="button"
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 text-slate-400 hover:text-white text-sm transition-colors"
                        >
                        Cancel
                        </button>
                        <button 
                        type="submit"
                        className="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-medium shadow-[0_0_15px_rgba(168,85,247,0.3)] transition-all flex items-center gap-2"
                        >
                        <Check size={16} />
                        Save
                        </button>
                    </div>
                    </form>
                </div>
                </div>
            )}
            </div>
        );
        };

        const SpreadsheetModule = () => {
        const [sheets, setSheets] = useState(() => {
            const saved = localStorage.getItem('nexus_sheets');
            return saved ? JSON.parse(saved) : [
            { id: 1, name: 'New Sheet', url: '', useProxy: false }
            ];
        });
        
        useDebouncedPersistence('nexus_sheets', sheets, 1000);

        const [isSplitMode, setIsSplitMode] = useState(false);
        const [activePane, setActivePane] = useState('primary'); 
        const [primarySheetId, setPrimarySheetId] = useState(() => sheets[0]?.id || 1);
        const [secondarySheetId, setSecondarySheetId] = useState(null); 

        const [isEditing, setIsEditing] = useState(false);
        const [editingSheet, setEditingSheet] = useState(null);

        const getSheet = (id) => sheets.find(s => s.id === id) || sheets[0];

        const handleTabClick = (id) => {
            if (isSplitMode) {
            if (activePane === 'primary') {
                setPrimarySheetId(id);
            } else {
                setSecondarySheetId(id);
            }
            } else {
            setPrimarySheetId(id);
            }
        };

        const toggleSplitMode = () => {
            if (!isSplitMode) {
            if (!secondarySheetId) setSecondarySheetId(primarySheetId);
            setIsSplitMode(true);
            setActivePane('secondary');
            } else {
            setIsSplitMode(false);
            setActivePane('primary');
            }
        };

        const handleAddSheet = () => {
            const newId = Date.now();
            const newSheet = { id: newId, name: `Sheet`, url: '', useProxy: false };
            setSheets([...sheets, newSheet]);
            handleTabClick(newId);
            setEditingSheet(newSheet);
            setIsEditing(true);
        };

        const handleSaveEdit = (e) => {
            e.preventDefault();
            setSheets(sheets.map(s => s.id === editingSheet.id ? editingSheet : s));
            setIsEditing(false);
            setEditingSheet(null);
        };

        const handleDeleteSheet = (id) => {
            if (sheets.length === 1) return; 
            const newSheets = sheets.filter(s => s.id !== id);
            setSheets(newSheets);
            const fallbackId = newSheets[0].id;
            if (primarySheetId === id) setPrimarySheetId(fallbackId);
            if (secondarySheetId === id) setSecondarySheetId(fallbackId);
        };

        const renderPane = (sheetId, paneType) => {
            const sheet = getSheet(sheetId);
            const isActive = isSplitMode && activePane === paneType;
            const displayUrl = sheet?.useProxy 
            ? `https://corsproxy.io/?${encodeURIComponent(sheet.url)}` 
            : sheet?.url;
            
            return (
            <div 
                className={`
                flex-1 relative h-full transition-all duration-200 overflow-hidden
                ${isActive ? 'ring-2 ring-purple-500/50 z-10' : 'ring-0'}
                ${isSplitMode && paneType === 'primary' ? 'border-r border-white/10' : ''}
                `}
                onClick={() => isSplitMode && setActivePane(paneType)}
            >
                {isSplitMode && !isActive && (
                <div className="absolute inset-0 z-20 bg-black/10 hover:bg-transparent cursor-pointer transition-colors" />
                )}

                {sheet?.url ? (
                <iframe 
                    src={displayUrl}
                    title={sheet.name}
                    className="w-full h-full border-none bg-white"
                    allowFullScreen
                />
                ) : (
                <div className="flex flex-col items-center justify-center h-full text-slate-500 bg-[#0f0f12]">
                    <Globe size={48} className="mb-4 opacity-50" />
                    <p>No URL configured for {sheet?.name || 'this sheet'}.</p>
                    <button 
                    onClick={(e) => { 
                        e.stopPropagation();
                        if (sheet) {
                        setEditingSheet(sheet); 
                        setIsEditing(true);
                        }
                    }}
                    className="mt-4 px-4 py-2 bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 rounded-lg transition-colors text-sm font-medium relative z-30"
                    >
                    Add URL
                    </button>
                </div>
                )}
            </div>
            );
        };

        const currentTabId = isSplitMode 
            ? (activePane === 'primary' ? primarySheetId : secondarySheetId)
            : primarySheetId;

        return (
            <div className="flex flex-col h-full relative bg-[#0a0a0c]">
            {/* Top Tab Bar */}
            <div className="h-10 bg-[#0a0a0c] border-b border-white/5 flex items-center px-2 space-x-1 relative z-20">
                <div className="flex-1 flex items-center overflow-x-auto h-full scrollbar-hide">
                {sheets.map((sheet) => (
                    <div 
                    key={sheet.id}
                    onClick={() => handleTabClick(sheet.id)}
                    onDoubleClick={(e) => {
                        e.stopPropagation();
                        setEditingSheet(sheet);
                        setIsEditing(true);
                    }}
                    title="Double-click to edit"
                    className={`
                        group flex items-center px-4 h-full rounded-t-lg cursor-pointer transition-all duration-200 select-none min-w-[120px] max-w-[200px] relative top-[1px]
                        ${currentTabId === sheet.id 
                        ? 'bg-[#0f0f12] text-purple-200 border-t border-x border-purple-500/30 border-b-[#0f0f12]' 
                        : 'text-slate-500 hover:bg-white/5 hover:text-slate-300 border-t border-x border-transparent'
                        }
                    `}
                    >
                    <span className="text-xs font-medium truncate flex-1 text-center">{sheet.name}</span>
                    </div>
                ))}
                
                <button 
                    onClick={handleAddSheet}
                    className="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-purple-400 hover:bg-white/5 rounded-full transition-colors ml-1 shrink-0"
                >
                    <Plus size={16} />
                </button>
                </div>

                <div className="border-l border-white/10 pl-2 ml-2 flex items-center">
                <button
                    onClick={toggleSplitMode}
                    title={isSplitMode ? "Single View" : "Split View"}
                    className={`
                    w-8 h-8 flex items-center justify-center rounded-lg transition-colors
                    ${isSplitMode 
                        ? 'bg-purple-600 text-white shadow-[0_0_10px_rgba(168,85,247,0.4)]' 
                        : 'text-slate-500 hover:text-purple-400 hover:bg-white/5'
                    }
                    `}
                >
                    {isSplitMode ? <Maximize size={16} /> : <Columns size={16} />}
                </button>
                </div>
            </div>

            <div className="flex-1 relative w-full h-full bg-[#0f0f12] flex flex-row">
                {renderPane(primarySheetId, 'primary')}
                {isSplitMode && renderPane(secondarySheetId, 'secondary')}
            </div>

            {isEditing && editingSheet && (
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-content">
                <div className="w-96 bg-[#1a1a1c] border border-white/10 rounded-2xl p-6 shadow-2xl shadow-purple-900/20">
                    <div className="flex justify-between items-center mb-6">
                    <h3 className="text-white font-medium flex items-center gap-2">
                        <Layout size={18} className="text-purple-400" />
                        Sheet Settings
                    </h3>
                    <button onClick={() => setIsEditing(false)} className="text-slate-500 hover:text-white">
                        <X size={18} />
                    </button>
                    </div>
                    
                    <form onSubmit={handleSaveEdit} className="space-y-4">
                    <div>
                        <label className="block text-xs uppercase tracking-wider text-slate-500 font-semibold mb-2">Tab Name</label>
                        <input 
                        type="text" 
                        value={editingSheet.name}
                        onChange={(e) => setEditingSheet({...editingSheet, name: e.target.value})}
                        className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2.5 text-white text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500/50 transition-all"
                        placeholder="e.g. Q1 Expenses"
                        autoFocus
                        />
                    </div>
                    
                    <div>
                        <label className="block text-xs uppercase tracking-wider text-slate-500 font-semibold mb-2">Embed URL</label>
                        <div className="relative">
                        <Globe size={14} className="absolute left-3.5 top-3.5 text-slate-500" />
                        <input 
                            type="url" 
                            value={editingSheet.url}
                            onChange={(e) => setEditingSheet({...editingSheet, url: e.target.value})}
                            className="w-full bg-black/40 border border-white/10 rounded-lg pl-10 pr-4 py-2.5 text-white text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500/50 transition-all"
                            placeholder="https://..."
                        />
                        </div>
                    </div>

                    <div className="bg-white/5 rounded-xl p-3 border border-white/5">
                        <div className="flex items-center justify-between">
                        <div className="flex flex-col">
                            <div className="flex items-center gap-2 text-slate-300 font-medium text-xs uppercase tracking-wider">
                            <ShieldAlert size={12} className="text-orange-400" />
                            Allow X-Frame
                            </div>
                            <span className="text-[10px] text-slate-500 mt-0.5">Force embed blocked sites</span>
                        </div>
                        <button
                            type="button"
                            onClick={() => setEditingSheet({...editingSheet, useProxy: !editingSheet.useProxy})}
                            className={`
                            w-10 h-5 rounded-full p-0.5 transition-colors duration-200 ease-in-out relative
                            ${editingSheet.useProxy ? 'bg-purple-600' : 'bg-white/10'}
                            `}
                        >
                            <div className={`
                            w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-200
                            ${editingSheet.useProxy ? 'translate-x-5' : 'translate-x-0'}
                            `} />
                        </button>
                        </div>
                    </div>

                    <div className="flex gap-3 mt-6 pt-4 border-t border-white/5">
                        <button 
                        type="button"
                        onClick={() => {
                            handleDeleteSheet(editingSheet.id);
                            setIsEditing(false);
                        }}
                        className="flex items-center justify-center px-4 py-2 bg-red-500/10 text-red-400 hover:bg-red-500/20 rounded-lg text-sm font-medium transition-colors"
                        >
                        <Trash2 size={16} />
                        </button>
                        <div className="flex-1"></div>
                        <button 
                        type="button"
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 text-slate-400 hover:text-white text-sm transition-colors"
                        >
                        Cancel
                        </button>
                        <button 
                        type="submit"
                        className="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-medium shadow-[0_0_15px_rgba(168,85,247,0.3)] transition-all flex items-center gap-2"
                        >
                        <Check size={16} />
                        Save Changes
                        </button>
                    </div>
                    </form>
                </div>
                </div>
            )}
            </div>
        );
        };

        const TimerPopup = ({ isOpen, onClose, models, startTimer }) => {
        const [selectedModel, setSelectedModel] = useState('');
        const [fanName, setFanName] = useState('');
        const [selectedMinutes, setSelectedMinutes] = useState(1);

        if (!isOpen) return null;

        const handleStart = (e) => {
            e.preventDefault();
            const time = parseInt(selectedMinutes);
            if(!time || time < 1 || time > 60) return;
            
            startTimer(selectedModel, fanName, time);
            onClose();
            setFanName('');
            setSelectedMinutes(1);
            setSelectedModel('');
        };

        const handleManualInput = (e) => {
            const val = e.target.value;
            if (val === '') {
            setSelectedMinutes('');
            return;
            }
            let num = parseInt(val);
            if (isNaN(num)) return;
            if (num > 60) num = 60;
            setSelectedMinutes(num);
        };

        return (
            <div className="absolute left-24 bottom-2 z-50 animate-in fade-in slide-in-from-bottom-2 duration-200">
            <div className="w-80 bg-[#0f0f12]/95 border border-white/10 rounded-2xl p-6 shadow-2xl shadow-purple-900/30 relative backdrop-blur-xl">
                
                <div className="absolute bottom-4 -left-2 w-4 h-4 bg-[#0f0f12] border-l border-b border-white/10 transform rotate-45" />

                <div className="relative z-10">
                    <div className="flex items-center justify-between mb-6">
                    <h3 className="text-white font-light flex items-center gap-2 text-sm tracking-widest uppercase opacity-80">
                        <Clock size={14} className="text-purple-400" />
                        New Timer
                    </h3>
                    <button onClick={onClose} className="text-slate-500 hover:text-white transition-colors">
                        <X size={16} />
                    </button>
                    </div>

                    <form onSubmit={handleStart} className="space-y-4">
                    {/* Inputs Group */}
                    <div className="space-y-4">
                        
                        {/* Model Selection Grid */}
                        <div className="space-y-2">
                        <label className="text-[10px] uppercase tracking-wider font-bold text-slate-500 pl-1">Select Model</label>
                        {models.length > 0 ? (
                            <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto scrollbar-thin scrollbar-thumb-white/10 pr-1">
                            {models.map(m => (
                                <button
                                key={m.id}
                                type="button"
                                onClick={() => setSelectedModel(m.name)}
                                className={`
                                    p-2 rounded-lg text-sm text-left transition-all border
                                    ${selectedModel === m.name 
                                    ? 'bg-purple-600/20 border-purple-500/50 text-white shadow-sm' 
                                    : 'bg-white/5 border-transparent text-slate-400 hover:bg-white/10 hover:text-white'
                                    }
                                `}
                                >
                                <div className="flex items-center gap-2">
                                    <div className="w-5 h-5 rounded-full bg-white/10 flex items-center justify-center shrink-0">
                                    <User size={10} />
                                    </div>
                                    <span className="truncate text-xs font-medium">{m.name}</span>
                                </div>
                                </button>
                            ))}
                            </div>
                        ) : (
                            <div className="text-center p-4 border border-dashed border-white/10 rounded-lg text-xs text-slate-500">
                            No models in settings
                            </div>
                        )}
                        {/* Hidden Input for validation if needed, or simple check in handler */}
                        <input type="hidden" required value={selectedModel} />
                        </div>

                        <div className="group relative">
                        <div className="absolute left-3 top-3.5 text-slate-500 group-focus-within:text-purple-400 transition-colors font-bold text-xs">@</div>
                        <input 
                            type="text"
                            required
                            value={fanName}
                            onChange={(e) => setFanName(e.target.value)}
                            placeholder="Fan Name"
                            className="w-full bg-white/5 border border-white/5 rounded-xl pl-10 pr-3 py-3 text-white text-sm focus:border-purple-500/50 focus:outline-none focus:ring-1 focus:ring-purple-500/30 transition-all placeholder:text-slate-600"
                        />
                        </div>

                        <div className="group relative">
                        <div className="absolute left-3 top-3.5 text-slate-500 group-focus-within:text-purple-400 transition-colors font-bold text-[10px] tracking-wider">MIN</div>
                        <input 
                            type="number"
                            required
                            min="1"
                            max="60"
                            value={selectedMinutes}
                            onChange={handleManualInput}
                            placeholder="Duration (1-60)"
                            className="w-full bg-white/5 border border-white/5 rounded-xl pl-10 pr-3 py-3 text-white text-sm focus:border-purple-500/50 focus:outline-none focus:ring-1 focus:ring-purple-500/30 transition-all placeholder:text-slate-600 appearance-none"
                        />
                        </div>
                    </div>

                    <button 
                        type="submit"
                        className="w-full py-4 bg-white text-black hover:bg-purple-50 rounded-xl text-sm font-bold tracking-wide shadow-[0_0_20px_rgba(255,255,255,0.1)] transition-all flex items-center justify-center gap-2 mt-2"
                    >
                        <Clock size={16} />
                        START TIMER
                    </button>
                    </form>
                </div>
            </div>
            </div>
        );
        };

        const NotificationStack = ({ activeTimers, notifications, dismiss, cancelTimer, onPositiveEnding }) => {
        const formatTime = (ms) => {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const getRemainingTime = (endTime) => {
            return formatTime(endTime - Date.now());
        };

        return (
            <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
            
            {/* Active Timers */}
            {activeTimers.map(timer => (
                <div 
                key={timer.id}
                className="pointer-events-auto w-80 bg-[#0f0f12]/60 backdrop-blur-md border border-white/10 rounded-xl p-4 shadow-2xl animate-in slide-in-from-right-full duration-500 flex items-center gap-3 relative overflow-hidden group"
                >
                {/* Progress Indication */}
                <div className="p-3 bg-white/5 rounded-lg text-purple-400 shrink-0 relative z-10 border border-white/5">
                    <Hourglass size={20} className="animate-pulse" />
                </div>
                
                <div className="flex-1 min-w-0 relative z-10">
                    <div className="flex items-baseline gap-2 mb-0.5">
                    <span className="text-white font-bold text-lg tracking-wider">
                        {getRemainingTime(timer.endTime)}
                    </span>
                    </div>
                    <p className="text-slate-400 text-xs truncate">
                    <span className="text-purple-300 font-medium">{timer.model}</span> 
                    <span className="mx-1 text-slate-600"></span>
                    {timer.fan}
                    </p>
                </div>

                <button 
                    onClick={() => cancelTimer(timer.id)}
                    className="text-slate-500 hover:text-red-400 transition-colors relative z-10 p-2"
                    title="Cancel Timer"
                >
                    <X size={16} />
                </button>
                </div>
            ))}

            {/* Completed Notifications */}
            {notifications.map(notif => (
                <div 
                key={notif.id}
                className="pointer-events-auto w-80 bg-[#151518] backdrop-blur-xl border border-purple-500/30 rounded-xl p-4 shadow-2xl animate-in slide-in-from-right-full duration-500 flex flex-col gap-4 relative overflow-hidden group"
                >
                {/* Completed Glow */}
                <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-indigo-500 animate-pulse" />
                <div className="absolute inset-0 bg-purple-500/5 pointer-events-none" />
                
                <div className="flex items-start gap-3 relative z-10">
                    <div className="p-3 bg-purple-500/10 rounded-lg text-purple-400 shrink-0">
                    <Bell size={20} className="animate-bounce" />
                    </div>
                    
                    <div className="flex-1 min-w-0">
                    <h4 className="text-white font-medium text-sm leading-tight mb-0.5">Time's Up!</h4>
                    <p className="text-slate-400 text-xs truncate">Model: <span className="text-purple-200">{notif.model}</span></p>
                    <p className="text-slate-400 text-xs truncate">Fan: <span className="text-white">{notif.fan}</span></p>
                    </div>
                </div>

                {/* Action Buttons */}
                <div className="grid grid-cols-2 gap-2 relative z-10">
                    <button 
                    onClick={() => dismiss(notif.id)}
                    className="flex items-center justify-center gap-2 py-2.5 bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/10 rounded-lg text-xs font-semibold text-slate-300 transition-all active:scale-95"
                    >
                    <MessageSquare size={14} />
                    Chat Fan
                    </button>
                    <button 
                    onClick={() => onPositiveEnding(notif)}
                    className="flex items-center justify-center gap-2 py-2.5 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/20 hover:border-purple-500/30 rounded-lg text-xs font-semibold text-purple-300 transition-all active:scale-95"
                    >
                    <Clock size={14} />
                    Positive Ending
                    </button>
                </div>
                </div>
            ))}
            </div>
        );
        };

        const App = () => {
        const [activeTab, setActiveTab] = useState('Spreadsheets');
        const [isTimerOpen, setIsTimerOpen] = useState(false);
        
        const audioRef = useRef(null);

        // Models State - Debounced Persistence
        const [models, setModels] = useState(() => {
            const saved = localStorage.getItem('nexus_models');
            return saved ? JSON.parse(saved) : [];
        });
        
        useDebouncedPersistence('nexus_models', models, 1000);

        // Sales Sheet URL State
        const [salesSheetUrl, setSalesSheetUrl] = useState(() => localStorage.getItem('nexus_sales_url') || '');
        const [isEditingSalesUrl, setIsEditingSalesUrl] = useState(false);

        useEffect(() => {
            localStorage.setItem('nexus_sales_url', salesSheetUrl);
        }, [salesSheetUrl]);

        // Ringtone State
        const [ringtone, setRingtone] = useState(() => {
            return localStorage.getItem('nexus_ringtone') || 'classic';
        });

        useEffect(() => {
            localStorage.setItem('nexus_ringtone', ringtone);
        }, [ringtone]);


        // Timer Logic
        const [timers, setTimers] = useState([]);
        const [notifications, setNotifications] = useState([]);

        const startTimer = (model, fan, minutes) => {
            const endTime = Date.now() + minutes * 60 * 1000;
            const newTimer = {
            id: Date.now(),
            model,
            fan,
            endTime
            };
            setTimers(prev => [...prev, newTimer]);
        };

        const cancelTimer = (id) => {
            setTimers(prev => prev.filter(t => t.id !== id));
        };

        const handlePositiveEnding = (notif) => {
            dismissNotification(notif.id);
            startTimer(notif.model, `${notif.fan} (Positive Ending)`, 5);
        };

        useEffect(() => {
            const interval = setInterval(() => {
            const now = Date.now();
            
            setTimers(prevTimers => {
                const remaining = [];
                const finished = [];
                
                prevTimers.forEach(t => {
                if (t.endTime <= now) {
                    finished.push(t);
                } else {
                    remaining.push(t);
                }
                });

                if (finished.length > 0) {
                const selectedTone = RINGTONES.find(r => r.id === ringtone) || RINGTONES[0];
                if (audioRef.current) {
                    audioRef.current.src = selectedTone.url;
                    audioRef.current.currentTime = 0;
                    audioRef.current.play().catch(e => console.log("Audio play failed", e));
                }
                setNotifications(prev => [...prev, ...finished]);
                }

                return remaining;
            });
            
            }, 1000);

            return () => clearInterval(interval);
        }, [ringtone]);

        const dismissNotification = (id) => {
            setNotifications(prev => prev.filter(n => n.id !== id));
        };


        // Navigation Items
        const navItems = [
            { id: 'Spreadsheets', icon: FileSpreadsheet },
            { id: 'Sales', icon: DollarSign },
            { id: 'Analytics', icon: TrendingUp },
            { id: 'Notes', icon: StickyNote },
            { id: 'Settings', icon: Settings },
        ];

        return (
            <div className="flex h-screen bg-[#050507] text-slate-200 selection:bg-purple-500/30" style={{ fontFamily: '"Plus Jakarta Sans", sans-serif' }}>
            
            {/* Hidden Audio Element for Ringtone */}
            <audio ref={audioRef} preload="auto" />

            {/* Notifications Layer */}
            <NotificationStack 
                activeTimers={timers} 
                notifications={notifications} 
                dismiss={dismissNotification}
                cancelTimer={cancelTimer}
                onPositiveEnding={handlePositiveEnding}
            />

            {/* Sidebar */}
            <aside 
                className="
                w-24 h-full
                bg-[#0a0a0c]/80 backdrop-blur-xl border-r border-white/5
                flex flex-col items-center
                shrink-0 z-40 relative
                "
            >
                {/* Main Navigation (Top) */}
                <nav className="flex-1 w-full flex flex-col items-center justify-center py-8 space-y-4 overflow-y-auto">
                {navItems.map((item) => (
                    <SidebarItem 
                    key={item.id}
                    icon={item.icon}
                    isTimer={false}
                    active={activeTab === item.id}
                    onClick={() => {
                        setActiveTab(item.id);
                        setIsTimerOpen(false);
                    }}
                    onDoubleClick={item.id === 'Sales' ? () => setIsEditingSalesUrl(true) : undefined}
                    />
                ))}
                </nav>

                {/* Bottom Actions (Timer Pinned Here) */}
                <div className="p-4 mb-2 w-full flex flex-col items-center border-t border-white/5 pt-6">
                <SidebarItem 
                    icon={Clock}
                    isTimer={true}
                    active={isTimerOpen}
                    onClick={() => setIsTimerOpen(!isTimerOpen)}
                />
                </div>

                {/* Timer Popup */}
                <TimerPopup 
                isOpen={isTimerOpen} 
                onClose={() => setIsTimerOpen(false)} 
                models={models}
                startTimer={startTimer}
                />
            </aside>

            {/* Main Content Area */}
            <div className="flex-1 bg-[#050507] overflow-hidden flex flex-col relative">
                <div className="flex-1 z-10 h-full">
                    {activeTab === 'Spreadsheets' ? (
                    <SpreadsheetModule />
                    ) : activeTab === 'Sales' ? (
                    <SalesSheetModule url={salesSheetUrl} />
                    ) : activeTab === 'Settings' ? (
                    <SettingsModule 
                        models={models} 
                        setModels={setModels} 
                        currentRingtone={ringtone}
                        setRingtone={setRingtone}
                    />
                    ) : activeTab === 'Analytics' ? (
                    <AnalyticsModule models={models} setModels={setModels} />
                    ) : activeTab === 'Notes' ? (
                    <NotesModule />
                    ) : (
                    <div className="h-full flex flex-col items-center justify-center">
                        <div className="p-6 rounded-full bg-white/5 mb-6">
                        {navItems.find(i => i.id === activeTab)?.icon({ size: 48, className: "text-slate-600 opacity-50" }) || <div />}
                        </div>
                        <h2 className="text-xl font-light text-slate-400">
                        {activeTab} Module
                        </h2>
                    </div>
                    )}
                </div>
            </div>

            {/* Sales URL Edit Modal */}
            {isEditingSalesUrl && (
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-content">
                <div className="w-96 bg-[#1a1a1c] border border-white/10 rounded-2xl p-6 shadow-2xl shadow-purple-900/20">
                    <div className="flex justify-between items-center mb-6">
                    <h3 className="text-white font-medium flex items-center gap-2">
                        <LinkIcon size={18} className="text-purple-400" />
                        Set Sales Sheet URL
                    </h3>
                    <button onClick={() => setIsEditingSalesUrl(false)} className="text-slate-500 hover:text-white">
                        <X size={18} />
                    </button>
                    </div>
                    
                    <form onSubmit={(e) => { e.preventDefault(); setIsEditingSalesUrl(false); }} className="space-y-4">
                    <div>
                        <label className="block text-xs uppercase tracking-wider text-slate-500 font-semibold mb-2">Iframe URL</label>
                        <div className="relative">
                        <Globe size={14} className="absolute left-3.5 top-3.5 text-slate-500" />
                        <input 
                            type="url" 
                            value={salesSheetUrl}
                            onChange={(e) => setSalesSheetUrl(e.target.value)}
                            className="w-full bg-black/40 border border-white/10 rounded-lg pl-10 pr-4 py-2.5 text-white text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500/50 transition-all"
                            placeholder="https://docs.google.com/spreadsheets/..."
                            autoFocus
                        />
                        </div>
                    </div>

                    <div className="flex gap-3 mt-6 pt-4 border-t border-white/5">
                        <div className="flex-1"></div>
                        <button 
                        type="button"
                        onClick={() => setIsEditingSalesUrl(false)}
                        className="px-4 py-2 text-slate-400 hover:text-white text-sm transition-colors"
                        >
                        Cancel
                        </button>
                        <button 
                        type="submit"
                        className="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-medium shadow-[0_0_15px_rgba(168,85,247,0.3)] transition-all flex items-center gap-2"
                        >
                        <Check size={16} />
                        Save URL
                        </button>
                    </div>
                    </form>
                </div>
                </div>
            )}

            </div>
        );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
